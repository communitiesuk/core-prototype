{% extends "layouts/base.njk" %}

{% import "macros.njk" as macro %}
{% from "macros.njk" import adminNavigation with context %}

{% set title = "Users" %}
{% set caption = thisOrganisation.name %}
{% set isGlobalView = isAdmin and path.startsWith("/users") %}
{% set notificationUser = users | selectwhere("id", query.userId) | first %}

{% block content %}
  {{ govukNotificationBanner({
    text: "An invitation to submit CORE data has been sent to " + notificationUser.name + ".",
    type: "success"
  }) if query.success == "invited" }}

  {{ govukNotificationBanner({
    text: "An invitation to submit CORE data has been resent to " + notificationUser.name + ".",
    type: "success"
  }) if query.success == "reinvited" }}

  {{ govukNotificationBanner({
    text: "User has been deleted.",
    type: "success"
  }) if query.success == "deleted" }}

  {% if isGlobalView %}
    {{ macro.heading(title) }}
  {% else %}
    {{ adminNavigation(title) if isAdmin else macro.heading(title, caption) }}
  {% endif %}

  {{ govukButton({
    href: "/users/new",
    text: "Invite user"
  }) if isAdmin or isCoordinator }}

  {{ appSearch({
    decorate: "q",
    classes: "govuk-!-margin-bottom-4",
    label: {
      classes: "govuk-!-margin-bottom-2",
      text: "Search by name or email address"
    }
  }) }}

  <hr class="govuk-section-break govuk-section-break--visible govuk-section-break--m">

  {% set userRows = [] %}
  {% for user in results %}
    {% set userPath = "/users/" + user.id %}
    {% set userOrganisation = data.organisations[user.organisationId].name %}
    {% set userRole = data.roles[user.role].name %}
    {% set row = userRows.push([{
        html: macro.entityHtml(user.name, userPath, user.email)
      }, {
        html: macro.entityHtml(userOrganisation, false, userRole)
      }, {
        text: macro.userLastActiveHtml(user)
      }])
    %}
  {% endfor %}

  {% set captionHtml %}
    <span class="govuk-!-margin-right-4">
      {% if q %}<b>56</b> users found of{% endif %}
      <b>{{ pagination.results.count }}</b> total users
    </span>
  {% endset %}

  {% if results.length %}
    {% call appFigure ({
      id: "users",
      caption: {
        html: captionHtml
      }
    }) %}
      {% call appTableGroup({
        labelledby: "users"
      }) %}
        {{ govukTable({
          firstCellIsHeader: true,
          head: [{
            classes: "govuk-!-width-one-quarter",
            text: "Name and email address"
          }, {
            classes: "govuk-!-width-one-half",
            text: "Organisation and role"
          }, {
            classes: "govuk-!-width-one-quarter",
            text: "Last logged in"
          }],
          rows: userRows
        }) }}
      {% endcall %}
      {{ appPagination(pagination) }}
    {% endcall %}
  {% else %}
    <p class="govuk-body">
      <strong>No users found</strong>
    </p>
  {% endif %}
{% endblock %}
